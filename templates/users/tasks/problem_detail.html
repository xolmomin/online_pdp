{% extends 'users/base.html' %}
{% load static %}

{% block title %}{{ problem.name }} | EduHub{% endblock %}

{% block custom_css %}
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"
    />
    <style>
        .editor-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .editor-header {
            background-color: #2563eb;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .editor-header button {
            font-size: 0.9rem;
            padding: 0.3rem 0.75rem;
            border-radius: 6px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .run-button {
            background-color: #22c55e;
            color: white;
        }

        .run-button:hover {
            background-color: #16a34a;
        }

        .submit-button {
            background-color: #3b82f6;
            color: white;
        }

        .submit-button:hover {
            background-color: #1d4ed8;
        }

        /* CodeMirror Editor */
        .CodeMirror {
            height: 100%;
            flex: 1;
            font-size: 0.95rem;
            border: none;
            border-radius: 0 0 12px 12px;
            background-color: white !important;
            color: #1f2937;
        }

        .CodeMirror-gutters {
            background-color: #f3f4f6 !important;
            border-right: 1px solid #e5e7eb;
        }

        /* Output section */
        .output-section {
            background-color: #eff6ff;
            color: #1e3a8a;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1.5rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .output-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        #output-box {
            white-space: pre-line;
        }
    </style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
        }

        /* --- Editor Styling --- */
        .editor-container {
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .editor-header {
            background: #2563eb;
            color: #fff;
            padding: 0.6rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-body {
            background: #f9fafb;
            font-family: 'Fira Code', monospace;
            color: #1f2937;
            font-size: 0.875rem;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
        }

        .editor-body pre {
            outline: none;
            white-space: pre;
        }

        .run-button {
            background: #22c55e;
            color: white;
            padding: 0.35rem 0.9rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .run-button:hover {
            background: #16a34a;
        }

        .submit-button {
            background: #3b82f6;
            color: white;
            padding: 0.35rem 0.9rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .submit-button:hover {
            background: #2563eb;
        }

        /* --- Output Styling --- */
        .output-section {
            background: #2563eb;
            color: #ffffff;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            border-top: 1px solid #1e40af;
        }

        .output-section h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* --- Left Section --- */
        .problem-container {
            background: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .problem-nav {
            background: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.6rem 1.25rem;
            border-radius: 0.75rem 0.75rem 0 0;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .problem-nav button:hover {
            color: #dbeafe;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="flex gap-6 p-6 h-[92vh] bg-gray-100">

        <!-- LEFT SIDE: Problem Section -->
        <div class="w-1/2 flex flex-col bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Blue Navigation Bar -->
            <div class="bg-blue-600 text-white flex gap-6 px-6 py-3 font-medium text-sm">
                <button class="hover:text-blue-200">Description</button>
                <button class="hover:text-blue-200">Editorial</button>
                <button class="hover:text-blue-200">Solutions</button>
                <button class="hover:text-blue-200">Submissions</button>
            </div>

            <!-- Problem Content -->
            <div class="p-8 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold text-gray-900">{{ problem.name }}</h1>
                    <span class="text-green-600 font-semibold text-sm">Solved ‚úÖ</span>
                </div>

                <div class="flex items-center gap-3 mb-6 text-sm">
                <span class="px-3 py-1 rounded-full font-medium
                  {% if problem.difficulty == 'Easy' %}bg-green-100 text-green-700
                  {% elif problem.difficulty == 'Medium' %}bg-yellow-100 text-yellow-700
                  {% else %}bg-red-100 text-red-700{% endif %}">
                  {{ problem.difficulty }}
                </span>
                    <span class="text-gray-400">#{{ problem.pk }}</span>

                    <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-md border border-blue-200">üí° Hint</span>
                    <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-md border border-blue-200">üè¢ Companies</span>
                    <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-md border border-blue-200">üß† Topics</span>
                </div>

                <article class="leading-relaxed mb-8 text-gray-700">
                    {{ problem.description|safe }}
                </article>


                    <div class="mb-8">
                        {% for example in problem.examples.all %}
                            <h2 class="text-lg font-semibold mb-2 text-gray-900">Example {{ forloop.counter }}:</h2>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                <p><span class="font-semibold text-blue-600">Input:</span>
                                    <code class="bg-gray-100 px-1 rounded">{{ example.input }}</code>
                                </p>
                                <p><span class="font-semibold text-blue-600">Output:</span>
                                    <code class="bg-gray-100 px-1 rounded">{{ example.output }}</code>
                                </p>
                                {% if example.explanation %}
                                    <p class="mt-1 text-gray-600">
                                        <span class="font-semibold text-blue-600">Explanation:</span> {{ example.explanation }}
                                    </p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                {% if problem.constraints %}
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold mb-2 text-gray-900">Constraints:</h2>
                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            {{ problem.constraints|linebreaksbr }}
                        </ul>
                    </div>
                {% endif %}

                <div class="text-gray-600 text-sm border-t border-gray-200 pt-4">
                    <span class="font-semibold text-gray-800">Follow-up:</span>
                    Can you come up with an algorithm that is less than
                    <code class="bg-gray-100 px-1 rounded">O(n¬≤)</code> time complexity?
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE (COLUMN): Editor + Output -->
        <div class="flex flex-col w-1/2 gap-6">

            <!-- Code Editor -->
            <div class="bg-white rounded-xl shadow-md flex flex-col flex-1">
                <div class="bg-blue-600 text-white flex justify-between items-center px-4 py-2 rounded-t-xl">
                    <span class="font-semibold">Python 3</span>
                    <div class="flex gap-2">
                        <button class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm font-medium">Run
                        </button>
                        <button class="bg-blue-500 hover:bg-blue-700 px-3 py-1 rounded text-sm font-medium">Submit
                        </button>
                    </div>
                </div>

                <div class="bg-gray-50 font-mono text-sm text-gray-800 p-0 h-64 overflow-hidden">
                    <textarea id="code-editor">

                    </textarea>
                </div>
            </div>


            <!-- Output Section -->
            <div class="bg-white rounded-xl shadow-md flex flex-col">
                <div class="bg-blue-600 text-white px-4 py-2 rounded-t-xl font-semibold">Output</div>
                <div id="output-box" class="bg-gray-50 text-sm font-mono text-gray-800 p-4 h-48 overflow-y-auto">
                    Run your code to see output here...
                </div>
            </div>
        </div>
    </div>
{% endblock %}



{% block custom_js %}
    <!-- Load CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const runButton = document.querySelector(".bg-green-500");
            const submitButton = document.querySelector(".bg-blue-500");
            const outputBox = document.getElementById("output-box");

            const runUrl = "{% url 'run_code' %}";
            const submitUrl = "{% url 'submit_code' %}";
            const problemId = {{ problem.pk }};

            // Initialize CodeMirror
            const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
                mode: "python",
                theme: "default",
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                lineWrapping: true,
            });

            async function sendCode(url, includeProblem = false) {
                const code = editor.getValue().trim(); // ‚úÖ from CodeMirror
                const body = includeProblem ? {code, problem_id: problemId} : {code};

                outputBox.textContent = "Running...";
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken")
                        },
                        body: JSON.stringify(body)
                    });

                    const data = await response.json();
                    outputBox.textContent = data.output || "No output returned.";
                } catch (err) {
                    outputBox.textContent = "Error: " + err.message;
                }
            }

            runButton.addEventListener("click", () => sendCode(runUrl));
            submitButton.addEventListener("click", () => sendCode(submitUrl, true));

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    const cookies = document.cookie.split(";");
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + "=")) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
{% endblock %}
