{% extends 'users/base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ problem.name }} | EduHub{% endblock %}

{% block custom_css %}
    <style>
        .editor-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .editor-header {
            background-color: #2563eb;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .editor-header button {
            font-size: 0.9rem;
            padding: 0.3rem 0.75rem;
            border-radius: 6px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .run-button {
            background-color: #22c55e;
            color: white;
        }

        .run-button:hover {
            background-color: #16a34a;
        }

        .submit-button {
            background-color: #3b82f6;
            color: white;
        }

        .submit-button:hover {
            background-color: #1d4ed8;
        }

        /* Output section */
        .output-section {
            background-color: #eff6ff;
            color: #1e3a8a;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1.5rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .output-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        #output-box {
            white-space: pre-line;
        }
    </style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* --- Editor Styling --- */
        .editor-container {
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .editor-header {
            background: #2563eb;
            color: #fff;
            padding: 0.6rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-body {
            background: #f9fafb;
            font-family: 'Fira Code', monospace;
            color: #1f2937;
            font-size: 0.875rem;
            padding: 1rem;
            overflow-y: auto;
        }

        .editor-body pre {
            outline: none;
            white-space: pre;
        }

        .run-button {
            background: #22c55e;
            color: white;
            padding: 0.35rem 0.9rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .run-button:hover {
            background: #16a34a;
        }

        .submit-button {
            background: #3b82f6;
            color: white;
            padding: 0.35rem 0.9rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .submit-button:hover {
            background: #2563eb;
        }

        /* --- Output Styling --- */
        .output-section {
            background: #2563eb;
            color: #ffffff;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            border-top: 1px solid #1e40af;
        }

        .output-section h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* --- Left Section --- */
        .problem-container {
            background: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .problem-nav {
            background: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.6rem 1.25rem;
            border-radius: 0.75rem 0.75rem 0 0;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .problem-nav button:hover {
            color: #dbeafe;
        }

        /* Resizable sections */
        .main-container {
            display: flex;
            gap: 0;
            padding: 0;
            height: 92vh;
            background: #f1f5f9;
            position: relative;
        }

        .resizable-section {
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Horizontal resizer for left/right panels */
        .horizontal-resizer {
            width: 8px;
            background-color: #e5e7eb;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background-color 0.2s;
            z-index: 10;
        }

        .horizontal-resizer:hover {
            background-color: #d1d5db;
        }

        .horizontal-resizer::before {
            content: "";
            width: 4px;
            height: 40px;
            background-color: #9ca3af;
            border-radius: 2px;
        }

        /* Vertical resizer for editor/output */
        .vertical-resizer {
            height: 8px;
            background-color: #e5e7eb;
            cursor: row-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background-color 0.2s;
        }

        .vertical-resizer:hover {
            background-color: #d1d5db;
        }

        .vertical-resizer::before {
            content: "";
            width: 40px;
            height: 4px;
            background-color: #9ca3af;
            border-radius: 2px;
        }

        .resizing {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Problem section styling */
        .problem-section {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
            margin: 1.5rem;
            margin-right: 0.75rem;
        }

        .problem-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Right panel container */
        .right-panel {
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
        }

        .editor-output-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
            padding: 1.5rem;
            padding-left: 0.75rem;
            gap: 0;
        }

        /* Right side containers */
        .editor-container-right {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .output-container-right {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .results-container-right {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Header styling for consistent height */
        .editor-header-right {
            background: #2563eb;
            color: #fff;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }

        .output-header-right {
            background: #2563eb;
            color: #fff;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            font-weight: 600;
        }

        .results-header-right {
            background: #2563eb;
            color: #fff;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            font-weight: 600;
        }

        /* Test results styling */
        .test-case {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.75rem;
        }

        .test-case:last-child {
            border-bottom: none;
        }

        .test-case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .test-case-title {
            font-weight: 600;
            color: #374151;
        }

        .test-case-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-passed {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-running {
            background-color: #fef3c7;
            color: #92400e;
        }

        .test-case-details {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .test-input, .test-expected, .test-actual {
            margin: 0.25rem 0;
        }

        .test-input span, .test-expected span, .test-actual span {
            font-weight: 600;
            color: #374151;
        }

        .results-content {
            flex: 1;
            overflow-y: auto;
            max-height: 200px;
        }

        .results-summary {
            padding: 1rem;
            background-color: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .summary-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .stat-passed {
            color: #166534;
        }

        .stat-failed {
            color: #991b1b;
        }

        .stat-total {
            color: #374151;
        }

        .summary-message {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-passed {
            color: #166534;
        }

        .message-failed {
            color: #991b1b;
        }

        .tabs {
            display: flex;
            background-color: #2563eb;
            border-bottom: 1px solid #e5e7eb;
        }

        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom-color: black;
            color: white;
            background-color: #2563eb;
            animation: fadeIn 0.2s;
        }

        .tab:hover:not(.active) {
            background-color: #2563eb;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Monaco Editor container */
        .monaco-editor-container {
            flex: 1;
            overflow: hidden;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="main-container">
        <!-- LEFT SIDE: Problem Section -->
        <div class="resizable-section" id="problem-section" style="width: 50%;">
            <div class="problem-section">
                <!-- Blue Navigation Bar -->
                <div class="bg-blue-600 text-white flex gap-6 px-6 py-3 font-medium text-sm rounded-t-xl">
                    <button class="hover:text-blue-200">Description</button>
                    <button class="hover:text-blue-200">Editorial</button>
                    <button class="hover:text-blue-200">Solutions</button>
                    <button class="hover:text-blue-200">Submissions</button>
                </div>

                <!-- Problem Content -->
                <div class="problem-content">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-3xl font-bold text-gray-900">{{ problem.name }}</h1>
                        <span class="text-green-600 font-semibold text-sm">Solved ✅</span>
                    </div>

                    <div class="flex items-center gap-3 mb-6 text-sm">
                        <span class="text-gray-400">#{{ problem.pk }}</span>

                        <span class="px-3 py-1 rounded-full font-medium
                      {% if problem.difficulty == 'Easy' %}bg-green-100 text-green-700
                      {% elif problem.difficulty == 'Medium' %}bg-yellow-100 text-yellow-700
                      {% else %}bg-red-100 text-red-700{% endif %}">
                      {{ problem.difficulty }}
                    </span>
                        <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-md border border-blue-200">🧠 Topics</span>
                    </div>

                    <article class="leading-relaxed mb-8 text-gray-700">
                        {{ problem.description|safe }}
                    </article>

                    <div class="mb-8">
                        {% for example in problem.examples.all %}
                            <h2 class="text-lg font-semibold mb-2 text-gray-900">Example {{ forloop.counter }}:</h2>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                <p><span class="font-semibold text-blue-600">Input:</span>
                                    <code class="bg-gray-100 px-1 rounded">{{ example.input }}</code>
                                </p>
                                <p><span class="font-semibold text-blue-600">Output:</span>
                                    <code class="bg-gray-100 px-1 rounded">{{ example.output }}</code>
                                </p>
                                {% if example.explanation %}
                                    <p class="mt-1 text-gray-600">
                                        <span class="font-semibold text-blue-600">Explanation:</span> {{ example.explanation }}
                                    </p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    {% if problem.constraints %}
                        <div class="mb-8">
                            <h2 class="text-lg font-semibold mb-2 text-gray-900">Constraints:</h2>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                {{ problem.constraints|linebreaksbr }}
                            </ul>
                        </div>
                    {% endif %}

                    <div class="text-gray-600 text-sm border-t border-gray-200 pt-4">
                        <span class="font-semibold text-gray-800">Follow-up:</span>
                        Can you come up with an algorithm that is less than
                        <code class="bg-gray-100 px-1 rounded">O(n²)</code> time complexity?
                    </div>
                </div>
            </div>
        </div>

        <!-- Horizontal Resizer for Left/Right Panels -->
        <div class="horizontal-resizer" id="horizontal-resizer"></div>

        <!-- RIGHT PANEL: Editor + Output + Results -->
        <div class="right-panel">
            <div class="editor-output-container">
                <!-- Code Editor -->
                <div class="editor-container-right resizable-section" id="editor-section" style="height: 50%;">
                    <div class="editor-header-right">
                        <span class="font-semibold">Python 3</span>
                        <div class="flex gap-2">
                            <button class="run-button bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm font-medium">
                                Run
                            </button>
                            <button class="submit-button bg-blue-500 hover:bg-blue-700 px-3 py-1 rounded text-sm font-medium">
                                Submit
                            </button>
                        </div>
                    </div>

                    <div class="monaco-editor-container">
                        <div id="python-editor" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>

                <!-- Vertical Resizer for Editor/Output -->
                <div class="vertical-resizer" id="vertical-resizer"></div>

                <!-- Output and Results Container -->
                <div class="resizable-section" id="output-results-section" style="height: 50%;">
                    <div class="results-container-right" style="height: 100%;">
                        <div class="tabs">
                            <div class="tab active" data-tab="output">Output</div>
                            <div class="tab" data-tab="results">Test Results</div>
                        </div>

                        <!-- Output Tab -->
                        <div class="tab-content active" id="output-tab">
                            <div id="output-box"
                                 class="bg-gray-50 text-sm font-mono text-gray-800 p-4 overflow-y-auto flex-1">
                                Run your code to see output here...
                            </div>
                        </div>

                        <!-- Test Results Tab -->
                        <div class="tab-content" id="results-tab">
                            <div class="results-content" id="test-results">
                                <div class="text-gray-500 text-sm p-4 text-center">
                                    Run your code to see test results...
                                </div>
                            </div>
                            <div class="results-summary" id="results-summary" style="display: none;">
                                <div class="summary-stats">
                                    <div class="stat stat-passed">
                                        <span>✅</span>
                                        <span id="passed-count">0</span> passed
                                    </div>
                                    <div class="stat stat-failed">
                                        <span>❌</span>
                                        <span id="failed-count">0</span> failed
                                    </div>
                                    <div class="stat stat-total">
                                        <span>📊</span>
                                        <span id="total-count">0</span> total
                                    </div>
                                </div>
                                <div class="summary-message" id="summary-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_js %}
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.min.js"></script>

    <script>
        // Initialize Monaco Editor
        require.config({
            paths: {
                'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs'
            }
        });

        let editor;

        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('python-editor'), {
                value: `# Write your Python code here\n\nclass Solution:\n  def {{problem.name|slugify_underscore}}(self, ...):\n`,
                language: "python",
                theme: "vs-light",
                automaticLayout: true,
                minimap: {enabled: false},
                fontSize: 14,
                scrollBeyondLastLine: false,
                wordWrap: "on"
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const runButton = document.querySelector(".run-button");
            const submitButton = document.querySelector(".submit-button");
            const outputBox = document.getElementById("output-box");
            const testResults = document.getElementById("test-results");
            const resultsSummary = document.getElementById("results-summary");
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            const runUrl = "{% url 'run_code' %}";
            const submitUrl = "{% url 'submit_code' %}";
            const problemId = {{ problem.pk }};

            // Tab switching functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');

                    // Update tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update tab contents
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabName}-tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });

            runButton.addEventListener("click", () => sendCode(runUrl));
            submitButton.addEventListener("click", () => sendCode(submitUrl, true));


            // Mock test cases data
            const testCases = [
                {
                    id: 1,
                    input: "nums = [2,7,11,15], target = 9",
                    expected: "[0,1]",
                    explanation: "Because nums[0] + nums[1] == 9, we return [0, 1]."
                },
                {
                    id: 2,
                    input: "nums = [3,2,4], target = 6",
                    expected: "[1,2]",
                    explanation: "Because nums[1] + nums[2] == 6, we return [1, 2]."
                },
                {
                    id: 3,
                    input: "nums = [3,3], target = 6",
                    expected: "[0,1]",
                    explanation: "Because nums[0] + nums[1] == 6, we return [0, 1]."
                }
            ];

            async function sendCode(url, includeProblem = false) {
                const code = editor.getValue().trim();
                const body = includeProblem ? {code, problem_id: problemId} : {code};

                outputBox.textContent = "Running...";
                testResults.innerHTML = '<div class="text-gray-500 text-sm p-4 text-center">Running tests...</div>';
                resultsSummary.style.display = 'none';

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken")
                        },
                        body: JSON.stringify(body)
                    });

                    const data = await response.json();

                    // ✅ Console Output
                    outputBox.textContent = data.output || "No output returned.";

                    // ✅ If server returned test results, show them nicely
                    if (Array.isArray(data.results)) {
                        displayTestResults(data.results);
                    }

                } catch (error) {
                    outputBox.textContent = "Error running code: " + error;
                }
            }

            function displayTestResults(results) {
                testResults.innerHTML = '';
                let passed = 0;
                let failed = 0;

                results.forEach((result, index) => {
                    const testCaseElement = document.createElement('div');
                    testCaseElement.className = 'test-case';

                    const statusClass = result.verdict === "AC" ? 'status-passed' : 'status-failed';
                    const statusText = result.verdict === "AC" ? 'Passed' : result.verdict;

                    testCaseElement.innerHTML = `
            <div class="test-case-header">
                <div class="test-case-title">Test Case #${result.testcase}</div>
                <div class="test-case-status ${statusClass}">${statusText}</div>
            </div>
            <div class="test-case-details">
                <div class="test-input"><span>Input:</span> ${result.input}</div>
                <div class="test-expected"><span>Expected:</span> ${result.expected}</div>
                <div class="test-actual"><span>Output:</span> ${result.actual || 'No output'}</div>
            </div>
        `;

                    testResults.appendChild(testCaseElement);

                    if (result.verdict === "AC") passed++;
                    else failed++;
                });

                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
                document.getElementById('total-count').textContent = results.length;

                const summaryMessage = document.getElementById('summary-message');
                if (passed === results.length) {
                    summaryMessage.textContent = '🎉 All test cases passed!';
                    summaryMessage.className = 'summary-message message-passed';
                } else {
                    summaryMessage.textContent = '❌ Some test cases failed';
                    summaryMessage.className = 'summary-message message-failed';
                }

                resultsSummary.style.display = 'block';
            }

            runButton.addEventListener("click", () => sendCode(runUrl));
            submitButton.addEventListener("click", () => sendCode(submitUrl, true));


            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Resizable functionality for horizontal split (left/right panels)
            const horizontalResizer = document.getElementById('horizontal-resizer');
            const problemSection = document.getElementById('problem-section');
            const rightPanel = document.querySelector('.right-panel');

            let isHorizontalResizing = false;

            horizontalResizer.addEventListener('mousedown', (e) => {
                isHorizontalResizing = true;
                document.body.classList.add('resizing');
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isHorizontalResizing) return;

                const containerRect = document.querySelector('.main-container').getBoundingClientRect();
                const containerWidth = containerRect.width;
                const x = e.clientX - containerRect.left;

                // Calculate new widths as percentages
                const problemWidthPercent = (x / containerWidth) * 100;
                const rightPanelWidthPercent = 100 - problemWidthPercent;

                // Apply minimum width constraints
                if (problemWidthPercent >= 20 && rightPanelWidthPercent >= 30) {
                    problemSection.style.width = `${problemWidthPercent}%`;
                    rightPanel.style.width = `${rightPanelWidthPercent}%`;

                    // Refresh Monaco editor layout
                    if (editor) {
                        setTimeout(() => editor.layout(), 0);
                    }
                }
            });

            // Resizable functionality for vertical split (editor/output)
            const verticalResizer = document.getElementById('vertical-resizer');
            const editorSection = document.getElementById('editor-section');
            const outputResultsSection = document.getElementById('output-results-section');
            const editorOutputContainer = document.querySelector('.editor-output-container');

            let isVerticalResizing = false;

            verticalResizer.addEventListener('mousedown', (e) => {
                isVerticalResizing = true;
                document.body.classList.add('resizing');
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isVerticalResizing) return;

                const containerRect = editorOutputContainer.getBoundingClientRect();
                const containerHeight = containerRect.height;
                const y = e.clientY - containerRect.top;

                // Calculate new heights as percentages
                const editorHeightPercent = (y / containerHeight) * 100;
                const outputResultsHeightPercent = 100 - editorHeightPercent;

                // Apply minimum height constraints
                if (editorHeightPercent >= 20 && outputResultsHeightPercent >= 20) {
                    editorSection.style.height = `${editorHeightPercent}%`;
                    outputResultsSection.style.height = `${outputResultsHeightPercent}%`;

                    // Refresh Monaco editor layout
                    if (editor) {
                        setTimeout(() => editor.layout(), 0);
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                isHorizontalResizing = false;
                isVerticalResizing = false;
                document.body.classList.remove('resizing');
            });
        });
    </script>
{% endblock %}